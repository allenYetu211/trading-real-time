# æŠ€æœ¯åˆ†ææ¨¡å—å¼€å‘æ¨¡å¼å’Œæ•°æ®ä¸€è‡´æ€§è§„èŒƒ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™ï¼šç»Ÿä¸€æ•°æ®æº

**é‡è¦ï¼šæ‰€æœ‰æŠ€æœ¯åˆ†æåŠŸèƒ½å¿…é¡»åŸºäº `CoreTechnicalAnalysisService` ç¡®ä¿æ•°æ®ä¸€è‡´æ€§**

### æ­£ç¡®çš„æœåŠ¡æ¶æ„
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ ¸å¿ƒæœåŠ¡ä½œä¸ºå”¯ä¸€æ•°æ®æº
export class SomeAnalysisService {
  constructor(
    private readonly coreTechnicalAnalysisService: CoreTechnicalAnalysisService
  ) {}

  async performAnalysis(symbol: string): Promise<AnalysisResult> {
    // é€šè¿‡æ ¸å¿ƒæœåŠ¡è·å–æ•°æ®
    const coreResult = await this.coreTechnicalAnalysisService.performComprehensiveAnalysis(symbol);
    
    // ä½¿ç”¨ç»Ÿä¸€çš„æ ¼å¼åŒ–å™¨
    return SomeFormatter.formatMessage(symbol, coreResult.trendAnalysis);
  }
}

// âŒ é”™è¯¯ï¼šç›´æ¥è°ƒç”¨åº•å±‚æœåŠ¡ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
export class BadAnalysisService {
  constructor(
    private readonly multiTimeframeTrendService: MultiTimeframeTrendService,
    private readonly supportResistanceService: SupportResistanceService
  ) {}

  async performAnalysis(symbol: string): Promise<AnalysisResult> {
    // ç›´æ¥è°ƒç”¨ï¼Œå¯èƒ½ä¸æ ¸å¿ƒæœåŠ¡è®¡ç®—ç»“æœä¸åŒ
    const trend = await this.multiTimeframeTrendService.analyzeMultiTimeframeTrend(symbol);
    const sr = await this.supportResistanceService.analyzeSupportResistance(symbol);
    // ...
  }
}
```

## ğŸ“Š æ•°æ®ä¸€è‡´æ€§è§„èŒƒ

### 1. æŠ€æœ¯åˆ†ææ•°æ®è·å–æ¨¡å¼
```typescript
// æ ‡å‡†æ¨¡å¼ï¼šé€šè¿‡æ ¸å¿ƒæœåŠ¡è·å–æ‰€æœ‰åˆ†ææ•°æ®
export class AnalysisProcessor {
  /**
   * æ ‡å‡†çš„æŠ€æœ¯åˆ†ææ•°æ®è·å–æ–¹æ³•
   */
  static async getUnifiedAnalysisData(
    coreService: CoreTechnicalAnalysisService,
    symbol: string
  ): Promise<CoreTechnicalAnalysisResult> {
    // ä¸€æ¬¡è°ƒç”¨è·å–æ‰€æœ‰åˆ†ææ•°æ®ï¼Œç¡®ä¿ä¸€è‡´æ€§
    return await coreService.performComprehensiveAnalysis(symbol);
  }

  /**
   * è·å–ç‰¹å®šç±»å‹çš„åˆ†ææ•°æ®
   */
  static async getTrendData(
    coreService: CoreTechnicalAnalysisService,
    symbol: string
  ): Promise<TrendAnalysis> {
    return await coreService.getTrendAnalysis(symbol);
  }

  static async getSupportResistanceData(
    coreService: CoreTechnicalAnalysisService,
    symbol: string
  ): Promise<SupportResistanceAnalysis> {
    return await coreService.getSupportResistanceAnalysis(symbol);
  }
}
```

### 2. æ ¼å¼åŒ–ä¸€è‡´æ€§è§„èŒƒ
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ç»Ÿä¸€çš„ç²¾ç¡®äº¤æ˜“åŒºé—´ç”Ÿæˆé€»è¾‘
export class ConsistentFormatter {
  static formatAnalysis(symbol: string, analysisData: any): string {
    // ä½¿ç”¨ç»Ÿä¸€çš„ç²¾ç¡®äº¤æ˜“åŒºé—´é€»è¾‘
    const preciseTradingZones = this.generatePreciseTradingZones(
      analysisData.srAnalysis, 
      analysisData.currentPrice
    );

    let message = `åˆ†æç»“æœ...`;

    // ç»Ÿä¸€çš„ç²¾ç¡®åŒºé—´æ ¼å¼
    if (preciseTradingZones.buyZones.length > 0) {
      message += `\nğŸ’š <b>ç²¾ç¡®ä¹°å…¥åŒºé—´:</b>\n`;
      preciseTradingZones.buyZones.forEach((zone: any) => {
        message += `â€¢ $${FormatUtil.formatPrice(zone.entry)} (Â±$${FormatUtil.formatPrice(zone.tolerance)}) [${zone.confidence}%]\n`;
      });
    }

    return message;
  }

  /**
   * ç»Ÿä¸€çš„ç²¾ç¡®äº¤æ˜“åŒºé—´ç”Ÿæˆé€»è¾‘
   * å¿…é¡»ä¸ ComprehensiveAnalysisFormatter ä¿æŒä¸€è‡´
   */
  private static generatePreciseTradingZones(srAnalysis: any, currentPrice: number): any {
    // æ ‡å‡†åŒ–çš„åŒºé—´è®¡ç®—é€»è¾‘
    const baseTolerancePercent = 0.005; // 0.5%
    const baseTolerance = currentPrice * baseTolerancePercent;
    // ... ç»Ÿä¸€çš„è®¡ç®—é€»è¾‘
  }
}
```

## ğŸ”§ æŠ€æœ¯åˆ†æå·¥å…·ç±»æ¨¡å¼

### 1. åˆ†æå¤„ç†å™¨è§„èŒƒ
```typescript
/**
 * æŠ€æœ¯åˆ†æå¤„ç†å™¨åŸºç±»æ¨¡å¼
 */
export abstract class BaseAnalysisProcessor {
  protected static readonly logger = new Logger(this.name);

  /**
   * æ ‡å‡†çš„åˆ†ææ‰§è¡Œæ¨¡æ¿
   */
  static async executeAnalysis<T>(
    coreService: CoreTechnicalAnalysisService,
    symbol: string,
    processor: (data: CoreTechnicalAnalysisResult) => T
  ): Promise<T> {
    try {
      this.logger.log(`å¼€å§‹æ‰§è¡Œ ${symbol} æŠ€æœ¯åˆ†æ`);
      
      // ç»Ÿä¸€æ•°æ®è·å–
      const coreData = await coreService.performComprehensiveAnalysis(symbol);
      
      // ç‰¹å®šå¤„ç†é€»è¾‘
      const result = processor(coreData);
      
      this.logger.log(`${symbol} æŠ€æœ¯åˆ†æå®Œæˆ`);
      return result;
      
    } catch (error) {
      this.logger.error(`æŠ€æœ¯åˆ†æå¤±è´¥ ${symbol}:`, error);
      throw new Error(`æŠ€æœ¯åˆ†æå¤±è´¥: ${error.message}`);
    }
  }
}

// å…·ä½“å®ç°ç¤ºä¾‹
export class TrendAnalysisProcessor extends BaseAnalysisProcessor {
  static async processTrendAnalysis(
    coreService: CoreTechnicalAnalysisService,
    symbol: string
  ): Promise<string> {
    return this.executeAnalysis(coreService, symbol, (coreData) => {
      return TrendAnalysisFormatter.formatMessage(symbol, coreData.trendAnalysis);
    });
  }
}
```

### 2. æ ¼å¼åŒ–å™¨ç»§æ‰¿æ¨¡å¼
```typescript
/**
 * æŠ€æœ¯åˆ†ææ ¼å¼åŒ–å™¨åŸºç±»
 */
export abstract class BaseAnalysisFormatter {
  /**
   * ç»Ÿä¸€çš„ä»·æ ¼æ ¼å¼åŒ–
   */
  protected static formatPrice(price: number): string {
    return FormatUtil.formatPrice(price);
  }

  /**
   * ç»Ÿä¸€çš„æ—¶é—´æ ¼å¼åŒ–
   */
  protected static formatTime(): string {
    return FormatUtil.formatTime();
  }

  /**
   * ç»Ÿä¸€çš„ç²¾ç¡®äº¤æ˜“åŒºé—´æ ¼å¼åŒ–
   */
  protected static formatPreciseTradingZones(
    buyZones: any[], 
    sellZones: any[]
  ): string {
    let message = '';

    if (buyZones.length > 0) {
      message += `\nğŸ’š <b>ç²¾ç¡®ä¹°å…¥åŒºé—´:</b>\n`;
      buyZones.forEach((zone: any) => {
        message += `â€¢ $${this.formatPrice(zone.entry)} (Â±$${this.formatPrice(zone.tolerance)}) [${zone.confidence}%]\n`;
      });
    }

    if (sellZones.length > 0) {
      message += `\nğŸ”´ <b>ç²¾ç¡®å–å‡ºåŒºé—´:</b>\n`;
      sellZones.forEach((zone: any) => {
        message += `â€¢ $${this.formatPrice(zone.entry)} (Â±$${this.formatPrice(zone.tolerance)}) [${zone.confidence}%]\n`;
      });
    }

    return message;
  }
}
```

## ğŸ“ˆ EMAå’Œè¶‹åŠ¿åˆ†æè§„èŒƒ

### 1. EMAæ•°æ®è·å–æ ‡å‡†
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ ‡å‡†EMAå‚æ•°å’Œæ•°æ®é‡
export class EMAAnalysisUtil {
  // æ ‡å‡†EMAå‘¨æœŸ
  static readonly STANDARD_EMA_PERIODS = [20, 60, 120];
  
  // æ ‡å‡†æ•°æ®é‡ (çº¦4-5ä¸ªæœˆæ•°æ®)
  static readonly STANDARD_KLINE_COUNT = 100;
  
  // æ ‡å‡†æ—¶é—´å‘¨æœŸ
  static readonly STANDARD_TIMEFRAME = '1d';

  static async getStandardEMAData(
    emaService: EMAAnalysisService,
    symbol: string
  ): Promise<{ analysis: any; detailedData: any }> {
    const [analysis, detailedData] = await Promise.all([
      emaService.analyzeEMA(symbol, this.STANDARD_TIMEFRAME, this.STANDARD_EMA_PERIODS),
      emaService.getDetailedEMAData(symbol, this.STANDARD_TIMEFRAME, this.STANDARD_EMA_PERIODS, this.STANDARD_KLINE_COUNT)
    ]);

    return { analysis, detailedData };
  }
}
```

### 2. å¤šæ—¶é—´å‘¨æœŸåˆ†æè§„èŒƒ
```typescript
// æ ‡å‡†çš„å¤šæ—¶é—´å‘¨æœŸé…ç½®
export class MultiTimeframeUtil {
  // æ ‡å‡†æ—¶é—´å‘¨æœŸ
  static readonly STANDARD_TIMEFRAMES = ['15m', '1h', '4h', '1d'];
  
  // æ—¶é—´å‘¨æœŸä¼˜å…ˆçº§ (ç”¨äºå†²çªè§£å†³)
  static readonly TIMEFRAME_PRIORITY = {
    '1d': 4,   // æœ€é«˜ä¼˜å…ˆçº§
    '4h': 3,
    '1h': 2,
    '15m': 1   // æœ€ä½ä¼˜å…ˆçº§
  };

  /**
   * æ ‡å‡†çš„è¶‹åŠ¿ä¸€è‡´æ€§åˆ†æ
   */
  static analyzeTrendConsistency(timeframeData: any): {
    isAligned: boolean;
    alignmentScore: number;
    conflictingTimeframes: string[];
  } {
    // æ ‡å‡†çš„ä¸€è‡´æ€§è®¡ç®—é€»è¾‘
    // å¿…é¡»ä¸æ ¸å¿ƒæœåŠ¡ä¿æŒä¸€è‡´
  }
}
```

## ğŸ¯ æ”¯æ’‘é˜»åŠ›ä½åˆ†æè§„èŒƒ

### 1. æ”¯æ’‘é˜»åŠ›ä½è¯†åˆ«æ ‡å‡†
```typescript
export class SupportResistanceUtil {
  // æ ‡å‡†å¼ºåº¦åˆ†ç±»
  static readonly STRENGTH_LEVELS = {
    MAJOR: 'MAJOR',
    STRONG: 'STRONG', 
    MEDIUM: 'MEDIUM',
    WEAK: 'WEAK'
  };

  // æ ‡å‡†ç½®ä¿¡åº¦é˜ˆå€¼
  static readonly CONFIDENCE_THRESHOLDS = {
    HIGH: 80,
    MEDIUM: 60,
    LOW: 40
  };

  /**
   * æ ‡å‡†çš„æ”¯æ’‘é˜»åŠ›ä½è¿‡æ»¤
   */
  static filterValidLevels(levels: any[]): any[] {
    return levels.filter(level => 
      level.confidence >= this.CONFIDENCE_THRESHOLDS.LOW &&
      level.strength !== this.STRENGTH_LEVELS.WEAK
    );
  }

  /**
   * æ ‡å‡†çš„ç²¾ç¡®äº¤æ˜“åŒºé—´è®¡ç®—
   */
  static calculatePreciseZones(
    levels: any[], 
    currentPrice: number,
    type: 'buy' | 'sell'
  ): any[] {
    const baseTolerancePercent = 0.005; // 0.5% - ä¸æ ¸å¿ƒæœåŠ¡ä¿æŒä¸€è‡´
    const baseTolerance = currentPrice * baseTolerancePercent;

    return levels
      .filter(level => this.isValidLevel(level, type))
      .slice(0, 3) // æœ€å¤š3ä¸ªåŒºé—´
      .map(level => ({
        entry: level.priceRange.center,
        tolerance: Math.min(baseTolerance, Math.abs(level.priceRange.max - level.priceRange.min) / 4),
        confidence: level.confidence,
        reason: `${level.timeframe}çº§åˆ«${level.strength}${type === 'buy' ? 'æ”¯æ’‘' : 'é˜»åŠ›'}ä½`
      }));
  }
}
```

## ğŸ” è´¨é‡æ£€æŸ¥æ¸…å•

åœ¨å¼€å‘æŠ€æœ¯åˆ†æç›¸å…³åŠŸèƒ½æ—¶ï¼Œå¿…é¡»æ£€æŸ¥ï¼š

### æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
- [ ] æ˜¯å¦ä½¿ç”¨ `CoreTechnicalAnalysisService` ä½œä¸ºæ•°æ®æºï¼Ÿ
- [ ] æ˜¯å¦ä¸å®Œæ•´æŠ€æœ¯åˆ†æçš„è®¡ç®—ç»“æœä¸€è‡´ï¼Ÿ
- [ ] ç²¾ç¡®äº¤æ˜“åŒºé—´æ ¼å¼æ˜¯å¦ç»Ÿä¸€ï¼Ÿ

### æŠ€æœ¯è§„èŒƒæ£€æŸ¥
- [ ] EMAå‚æ•°æ˜¯å¦ä½¿ç”¨æ ‡å‡†é…ç½® (20, 60, 120)ï¼Ÿ
- [ ] æ˜¯å¦ä½¿ç”¨æ ‡å‡†çš„100æ ¹Kçº¿æ•°æ®é‡ï¼Ÿ
- [ ] å¤šæ—¶é—´å‘¨æœŸæ˜¯å¦ä½¿ç”¨æ ‡å‡†é…ç½® (15m, 1h, 4h, 1d)ï¼Ÿ

### æ ¼å¼åŒ–è§„èŒƒæ£€æŸ¥
- [ ] æ˜¯å¦ä½¿ç”¨ç»Ÿä¸€çš„æ ¼å¼åŒ–å·¥å…·ï¼Ÿ
- [ ] ä»·æ ¼æ ¼å¼æ˜¯å¦ä¸€è‡´ï¼Ÿ
- [ ] è¡¨æƒ…ç¬¦å·æ˜¯å¦ä½¿ç”¨ç»Ÿä¸€çš„å·¥å…·ç±»ï¼Ÿ

### é”™è¯¯å¤„ç†æ£€æŸ¥
- [ ] æ˜¯å¦æœ‰å®Œæ•´çš„é”™è¯¯å¤„ç†ï¼Ÿ
- [ ] æ˜¯å¦æœ‰é€‚å½“çš„æ—¥å¿—è®°å½•ï¼Ÿ
- [ ] æ˜¯å¦æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯ï¼Ÿ

## ğŸš€ æœ€ä½³å®è·µç¤ºä¾‹

å‚è€ƒä»¥ä¸‹æˆåŠŸå®ç°ï¼š
- [CoreTechnicalAnalysisService](mdc:src/modules/technical-analysis/services/core-technical-analysis.service.ts) - æ ¸å¿ƒæ•°æ®æœåŠ¡
- [ComprehensiveAnalysisFormatter](mdc:src/modules/telegram-ccxt-analysis/utils/formatters/comprehensive-analysis.formatter.ts) - æ ‡å‡†æ ¼å¼åŒ–å™¨
- [AnalysisProcessorUtil](mdc:src/modules/telegram-ccxt-analysis/utils/analysis/analysis-processor.util.ts) - åˆ†æå¤„ç†å™¨æ¨¡å¼
description:
globs:
alwaysApply: false
---
